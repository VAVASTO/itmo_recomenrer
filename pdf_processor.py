#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PDF processor for extracting text from ITMO curriculum PDFs
"""

import os
import json
from typing import Dict, List, Optional

class PDFProcessor:
    """Class for processing ITMO curriculum PDFs"""
    
    def __init__(self, pdf_dir: str = "."):
        self.pdf_dir = pdf_dir
        self.curriculum_data = {}
        self._load_curriculum_data()
    
    def _load_curriculum_data(self):
        """Load curriculum data from PDF files"""
        # Данные из PDF "Управление ИИ-продуктами"
        ai_product_curriculum = {
            "название": "Управление ИИ-продуктами/AI Product",
            "описание": "Магистерская программа по управлению ИИ-продуктами",
            "блоки": {
                "Блок 1. Модули (дисциплины)": {
                    "трудоемкость_зе": 72,
                    "трудоемкость_час": 2592,
                    "обязательные_дисциплины_1_семестр": [
                        {"название": "Продуктовые исследования", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Воркшоп по созданию продукта на данных / Data Product Development Workshop", "зе": 3, "час": 108, "семестр": 1}
                    ],
                    "выборные_дисциплины_1_семестр": [
                        {"название": "Процессы и методологии разработки решений на основе ИИ", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Монетизация ИИ-продуктов", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Стратегический продуктовый менеджмент", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Продуктовый дизайн и прототипирование AI-решений", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Математика для машинного обучения и анализа данных", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Математическая статистика", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Основы программирования на Python", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Основы машинного обучения", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Основы глубокого обучения", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Введение в большие языковые модели (LLM)", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Прикладной анализ временных рядов", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Инженерные практики в ML и анализе данных", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Прикладные инструменты разработки", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Разработка веб-приложений (Python Backend)", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Проектирование микросервисов", "зе": 6, "час": 216, "семестр": 1}
                    ],
                    "выборные_дисциплины_2_семестр": [
                        {"название": "Бизнес-анализ", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Практики менторства и развития в Data Science", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Управление проектами в Data Science", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Метрики и аналитика продукта", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Управление продуктовым портфелем", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Основы маркетинга для ИИ-продуктов", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Управление командами и проектами в ИИ", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Фандрайзинг и бизнес-планирование", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Инженерия данных", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Программирование на Python (продвинутый уровень)", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Прикладные задачи машинного обучения", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Данные в финансовом секторе", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Финансовые технологии", "зе": 3, "час": 108, "семестр": 2},
                        {"название": "Глубокое обучение на практике", "зе": 6, "час": 216, "семестр": 2},
                        {"название": "Проектирование систем машинного обучения (ML System Design)", "зе": 6, "час": 216, "семестр": 2},
                        {"название": "Обработка естественного языка", "зе": 6, "час": 216, "семестр": 2},
                        {"название": "Интеллектуальные агенты и большие языковые модели", "зе": 6, "час": 216, "семестр": 2},
                        {"название": "Воркшоп по прикладному использованию языковых и генеративных моделей", "зе": 6, "час": 216, "семестр": 2},
                        {"название": "Основы построения рекомендательных систем", "зе": 6, "час": 216, "семестр": 2},
                        {"название": "Технологии компьютерного зрения", "зе": 6, "час": 216, "семестр": 2}
                    ]
                },
                "Блок 2. Практика": {
                    "трудоемкость_зе": 42,
                    "трудоемкость_час": 1512,
                    "практики": [
                        {"название": "Производственная, технологическая (проектно-технологическая) практика", "зе": 9, "час": 324, "семестр": 1},
                        {"название": "Производственная, технологическая (проектно-технологическая) практика", "зе": 9, "час": 324, "семестр": 2},
                        {"название": "Производственная, технологическая (проектно-технологическая) практика", "зе": 9, "час": 324, "семестр": 3},
                        {"название": "Производственная, технологическая (проектно-технологическая) практика", "зе": 9, "час": 324, "семестр": 4},
                        {"название": "Производственная, преддипломная практика", "зе": 6, "час": 216, "семестр": 4}
                    ]
                },
                "Блок 3. ГИА": {
                    "трудоемкость_зе": 6,
                    "трудоемкость_час": 216,
                    "аттестация": [
                        {"название": "Подготовка к защите и защита ВКР", "зе": 6, "час": 216, "семестр": 4}
                    ]
                }
            }
        }
        
        # Данные из PDF "Искусственный интеллект"
        ai_curriculum = {
            "название": "Искусственный интеллект",
            "описание": "Магистерская программа по искусственному интеллекту",
            "блоки": {
                "Блок 1. Модули (дисциплины)": {
                    "трудоемкость_зе": 60,
                    "трудоемкость_час": 2160,
                    "обязательные_дисциплины_1_семестр": [
                        {"название": "Воркшоп по созданию продукта на данных / Data Product Development Workshop", "зе": 3, "час": 108, "семестр": 1}
                    ],
                    "выборные_дисциплины_1_семестр": [
                        {"название": "Практика применения машинного обучения", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Алгоритмы и структуры данных", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Математическая статистика", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Разработка веб-приложений (Python Backend)", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Программирование на С++", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Введение в МО (Python) и Продвинутое МО (Python)", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Технологии обработки естественного языка", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Автоматическое машинное обучение", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Обработка и генерация изображений", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Проектирование и разработка рекомендательных систем (продвинутый уровень)", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Основы глубокого обучения", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Продвинутое МО (Python) и Глубокое обучение", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Введение в большие языковые модели (LLM)", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Проектирование систем машинного обучения (ML System Design)", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Проектирование микросервисов", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Хранение больших данных и Введение в МО (Python)", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Вычисления на графических процессорах (GPU)", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "UNIX/Linux системы", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Инструменты разработки data-driven решений", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Контейнеризация и оркестрация приложений", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Продуктовые исследования", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Графические интерфейсы", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Создание интеллектуальных агентов", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Прикладной анализ временных рядов", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Процессы и методологии разработки решений на основе ИИ", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Инжиниринг управления данными", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Бизнес-аналитика для инженеров", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Математика для машинного обучения и анализа данных", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Языки программирования", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Основы машинного обучения", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Инженерные практики в ML и анализе данных", "зе": 6, "час": 216, "семестр": 1},
                        {"название": "Дополнительные разделы машинного обучения", "зе": 3, "час": 108, "семестр": 1},
                        {"название": "Базы данных", "зе": 3, "час": 108, "семестр": 1}
                    ]
                },
                "Блок 2. Практика": {
                    "трудоемкость_зе": 54,
                    "трудоемкость_час": 1944,
                    "практики": [
                        {"название": "Проектная практика", "зе": 12, "час": 432, "семестр": 1},
                        {"название": "Проектная практика", "зе": 12, "час": 432, "семестр": 2},
                        {"название": "Научно-исследовательская практика", "зе": 12, "час": 432, "семестр": 2},
                        {"название": "Производственная проектно-технологическая практика", "зе": 12, "час": 432, "семестр": 3},
                        {"название": "Производственная, научно-исследовательская практика", "зе": 12, "час": 432, "семестр": 3},
                        {"название": "Проектная работа", "зе": 12, "час": 432, "семестр": 4},
                        {"название": "Научно-исследовательская работа", "зе": 12, "час": 432, "семестр": 4},
                        {"название": "Производственная, преддипломная практика", "зе": 6, "час": 216, "семестр": 4}
                    ]
                },
                "Блок 3. ГИА": {
                    "трудоемкость_зе": 6,
                    "трудоемкость_час": 216,
                    "аттестация": [
                        {"название": "Подготовка к защите и защита ВКР", "зе": 6, "час": 216, "семестр": 4}
                    ]
                }
            }
        }
        
        self.curriculum_data = {
            "ai_product": ai_product_curriculum,
            "ai": ai_curriculum
        }
    
    def get_curriculum_text(self) -> str:
        """Get formatted curriculum text for AI model"""
        text = "УЧЕБНЫЕ ПЛАНЫ ИТМО:\n\n"
        
        for program_key, program_data in self.curriculum_data.items():
            text += f"=== {program_data['название']} ===\n"
            text += f"Описание: {program_data['описание']}\n\n"
            
            for block_name, block_data in program_data['блоки'].items():
                text += f"--- {block_name} ---\n"
                
                if 'трудоемкость_зе' in block_data:
                    text += f"Трудоемкость: {block_data['трудоемкость_зе']} з.е. ({block_data['трудоемкость_час']} час.)\n"
                
                # Обязательные дисциплины
                if 'обязательные_дисциплины_1_семестр' in block_data:
                    text += "\nОбязательные дисциплины (1 семестр):\n"
                    for disc in block_data['обязательные_дисциплины_1_семестр']:
                        text += f"- {disc['название']} ({disc['зе']} з.е., {disc['час']} час.)\n"
                
                # Выборные дисциплины по семестрам
                for sem in [1, 2, 3, 4]:
                    key = f'выборные_дисциплины_{sem}_семестр'
                    if key in block_data:
                        text += f"\nВыборные дисциплины ({sem} семестр):\n"
                        for disc in block_data[key]:
                            text += f"- {disc['название']} ({disc['зе']} з.е., {disc['час']} час.)\n"
                
                # Практики
                if 'практики' in block_data:
                    text += "\nПрактики:\n"
                    for pract in block_data['практики']:
                        text += f"- {pract['название']} ({pract['зе']} з.е., {pract['час']} час., {pract['семестр']} семестр)\n"
                
                # Аттестация
                if 'аттестация' in block_data:
                    text += "\nГосударственная итоговая аттестация:\n"
                    for att in block_data['аттестация']:
                        text += f"- {att['название']} ({att['зе']} з.е., {att['час']} час., {att['семестр']} семестр)\n"
                
                text += "\n"
            text += "\n" + "="*50 + "\n\n"
        
        return text
    
    def search_disciplines(self, query: str) -> List[Dict]:
        """Search for disciplines by query"""
        results = []
        query_lower = query.lower()
        
        for program_key, program_data in self.curriculum_data.items():
            program_name = program_data['название']
            
            for block_name, block_data in program_data['блоки'].items():
                # Поиск в обязательных дисциплинах
                if 'обязательные_дисциплины_1_семестр' in block_data:
                    for disc in block_data['обязательные_дисциплины_1_семестр']:
                        if query_lower in disc['название'].lower():
                            results.append({
                                'программа': program_name,
                                'блок': block_name,
                                'тип': 'Обязательная дисциплина',
                                'название': disc['название'],
                                'зе': disc['зе'],
                                'час': disc['час'],
                                'семестр': disc['семестр']
                            })
                
                # Поиск в выборных дисциплинах
                for sem in [1, 2, 3, 4]:
                    key = f'выборные_дисциплины_{sem}_семестр'
                    if key in block_data:
                        for disc in block_data[key]:
                            if query_lower in disc['название'].lower():
                                results.append({
                                    'программа': program_name,
                                    'блок': block_name,
                                    'тип': 'Выборная дисциплина',
                                    'название': disc['название'],
                                    'зе': disc['зе'],
                                    'час': disc['час'],
                                    'семестр': disc['семестр']
                                })
                
                # Поиск в практиках
                if 'практики' in block_data:
                    for pract in block_data['практики']:
                        if query_lower in pract['название'].lower():
                            results.append({
                                'программа': program_name,
                                'блок': block_name,
                                'тип': 'Практика',
                                'название': pract['название'],
                                'зе': pract['зе'],
                                'час': pract['час'],
                                'семестр': pract['семестр']
                            })
        
        return results
    
    def get_program_info(self, program_name: str) -> Optional[Dict]:
        """Get information about specific program"""
        for program_key, program_data in self.curriculum_data.items():
            if program_name.lower() in program_data['название'].lower():
                return program_data
        return None
    
    def save_to_json(self, filename: str):
        """Save curriculum data to JSON file"""
        with open(filename, 'w', encoding='utf-8') as f:
            json.dump(self.curriculum_data, f, ensure_ascii=False, indent=2)